#!/bin/bash

set -e

LOCK_FILE="/root/n8n_data/update.lock"
CRON_MARKER="# N8N Monthly Auto-Update"
CRON_ENTRY="5 3 1 * * /root/N8N/nightly-update-n8n.sh >> /var/log/n8n-nightly-update.log 2>&1"

# üß† –î–æ–±–∞–≤–ª—è–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ crontab, –µ—Å–ª–∏ –µ–≥–æ –µ—â—ë –Ω–µ—Ç
if ! crontab -l 2>/dev/null | grep -qF "$CRON_MARKER"; then
  echo "üõ†Ô∏è –î–æ–±–∞–≤–ª—è–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ crontab..."
  (crontab -l 2>/dev/null; echo "$CRON_MARKER"; echo "$CRON_ENTRY") | crontab -
fi

# üïí –ü—Ä–æ–≤–µ—Ä–∫–∞: –∑–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –≤ 03:00‚Äì03:59
CURRENT_HOUR=$(date +%H)
if [ "$CURRENT_HOUR" -ne 03 ]; then
  echo "‚è∞ –°–µ–π—á–∞—Å –Ω–µ 3 —á–∞—Å –Ω–æ—á–∏. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ."
  exit 0
fi

# üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
if [ -f "$LOCK_FILE" ]; then
  echo "üõë –ù–∞–π–¥–µ–Ω update.lock. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ."
  exit 1
fi

echo "üì¶ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–π –æ–±—Ä–∞–∑ n8n..."
docker pull n8nio/n8n:latest || { echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑"; exit 1; }

echo "üßπ –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π –±–∞–∑–æ–≤—ã–π –æ–±—Ä–∞–∑ (–≥–∞—Ä–∞–Ω—Ç–∏—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏)..."
docker rmi n8nio/n8n:latest || true

echo "üßπ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker-compose down || { echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"; exit 1; }

echo "üî® –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π Dockerfile —Å --no-cache..."
docker-compose build --no-cache || { echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ Dockerfile"; exit 1; }

echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker-compose up -d || { echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"; exit 1; }

echo "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è n8n:"
docker exec -i n8n_n8n_1 n8n --version || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–µ—Ä—Å–∏—é n8n"