name: CI/CD for N8N

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: deploy-n8n
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Используем ssh-agent вместо Docker-экшена, чтобы избежать ошибок сборки
      - name: Start ssh-agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.SERVER_HOST }}" >> ~/.ssh/known_hosts

      - name: Remote deploy over SSH
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          set -Eeuo pipefail

          ssh -o ServerAliveInterval=30 -o ServerAliveCountMax=3 "${SERVER_USER}@${SERVER_HOST}" 'bash -s' <<'REMOTE'
          set -Eeuo pipefail

          HOST_DOMAIN="https://n8n.portalgm.ru"
          REPO_DIR="/root/N8N"
          COMPOSE_FILE="$REPO_DIR/docker-compose.yml"
          LOG="/var/log/n8n-deploy.log"
          touch "$LOG" && chmod 644 "$LOG" || true

          echo "=== [deploy] start ===" | tee -a "$LOG"

          # 1) Репозиторий на сервере
          if [ ! -d "$REPO_DIR/.git" ]; then
            echo "[deploy] cloning repo into $REPO_DIR" | tee -a "$LOG"
            git clone https://github.com/girudomed/N8N.git "$REPO_DIR"
          fi

          cd "$REPO_DIR"

          # сохранить локальный .env перед жёстким сбросом
          [ -f .env ] && cp .env /tmp/.env.keep || true

          git fetch origin
          git reset --hard origin/main
          echo "[deploy] git reset -> origin/main" | tee -a "$LOG"

          # вернуть локальный .env обратно
          [ -f /tmp/.env.keep ] && mv /tmp/.env.keep .env || true

          # 2) Подбираем рабочий образ N8N и фиксируем его в .env
          choose_image() {
            for img in "$@"; do
              [ -z "$img" ] && continue
              if docker image inspect "$img" >/dev/null 2>&1; then
                echo "$img"
                return 0
              fi
              echo "[deploy] pulling image candidate: $img" | tee -a "$LOG"
              if docker pull "$img" >>"$LOG" 2>&1; then
                echo "$img"
                return 0
              fi
            done
            return 1
          }

          # Кандидаты: приоритет локального .env, затем реестры по убыванию «надёжности»
          ENV_IMG=""
          if [ -f .env ] && grep -q '^N8N_IMAGE=' .env; then
            ENV_IMG="$(grep -E '^N8N_IMAGE=' .env | tail -n1 | cut -d= -f2-)"
          fi
          CHOSEN_IMAGE="$(choose_image "$ENV_IMG" \
            "docker.n8n.io/n8nio/n8n:latest" \
            "n8nio/n8n:latest" \
            "ghcr.io/n8n-io/n8n:latest")" || {
            echo "[deploy] ERROR: не удалось подобрать рабочий образ n8n" | tee -a "$LOG"
            exit 1
          }

          if grep -q '^N8N_IMAGE=' .env 2>/dev/null; then
            TMP_ENV="$(mktemp)"
            # Используем awk вместо sed, чтобы не экранировать спецсимволы
            awk -v repl="$CHOSEN_IMAGE" '
              BEGIN { replaced=0 }
              /^N8N_IMAGE=/ {
                if (!replaced) {
                  print "N8N_IMAGE=" repl
                  replaced=1
                }
                next
              }
              { print }
              END {
                if (!replaced) {
                  print "N8N_IMAGE=" repl
                }
              }
            ' .env > "$TMP_ENV"
            mv "$TMP_ENV" .env
          else
            echo "N8N_IMAGE=$CHOSEN_IMAGE" >> .env
          fi
          export N8N_IMAGE="$CHOSEN_IMAGE"
          echo "[deploy] using image: $N8N_IMAGE" | tee -a "$LOG"

          # 3) Запуск через docker compose напрямую, без update-n8n.sh
          # Если внутри compose используется ${N8N_IMAGE}, он возьмётся из .env.
          COMPOSE_BIN="docker compose"
          $COMPOSE_BIN version >/dev/null 2>&1 || COMPOSE_BIN="docker-compose"

          $COMPOSE_BIN -f "$COMPOSE_FILE" pull || {
            echo "[deploy] WARN: compose pull вернул ошибку, продолжаю" | tee -a "$LOG"
          }
          $COMPOSE_BIN -f "$COMPOSE_FILE" up -d

          # 5) Ротация бэкапов (держим по 2-3 свежих архива)
          ls -1t /root/n8n_backups/n8n_data_*.tar.gz  2>/dev/null | tail -n +3 | xargs -r rm -f || true
          ls -1t /root/n8n_backups/n8n_image_*.tar.gz 2>/dev/null | tail -n +2 | xargs -r rm -f || true

          # 6) HEALTHCHECK (фаза 1): Caddy /health — мягкая проверка
          echo "[deploy] health phase1: Caddy /health" | tee -a "$LOG"
          PH1_OK=0
          for i in {1..20}; do
            CODE="$(curl -s -o /dev/null -w "%{http_code}" --max-time 5 "${HOST_DOMAIN}/health" || echo "000")"
            if [ "$CODE" = "200" ] || [ "$CODE" = "404" ]; then
              echo "[deploy] /health -> $CODE" | tee -a "$LOG"
              PH1_OK=1
              break
            fi
            echo "[deploy] /health not ready yet (HTTP $CODE), try $i/20, wait 5s..." | tee -a "$LOG"
            sleep 5
          done
          [ "$PH1_OK" -ne 1 ] && echo "[deploy] WARN: /health не 200/404 — продолжу" | tee -a "$LOG"

          # 7) HEALTHCHECK (фаза 2): ждём n8n за прокси
          echo "[deploy] health phase2: wait n8n behind proxy" | tee -a "$LOG"
          READY=0
          for i in {1..40}; do
            CODE="$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${HOST_DOMAIN}/" || echo "000")"
            CODE_HEALTH="$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${HOST_DOMAIN}/rest/health" || echo "000")"
            if [ "$CODE" = "200" ] || [ "$CODE" = "204" ] || [ "$CODE" = "401" ] || [ "$CODE_HEALTH" = "200" ]; then
              echo "[deploy] n8n ready (/=$CODE, /rest/health=$CODE_HEALTH)" | tee -a "$LOG"
              READY=1
              break
            fi
            echo "[deploy] not ready yet (/=$CODE, /rest/health=$CODE_HEALTH), try $i/40, wait 5s..." | tee -a "$LOG"
            sleep 5
          done

          if [ "$READY" -ne 1 ]; then
            echo "[deploy] FAIL: n8n did not become ready in time. Dumping diagnostics..." | tee -a "$LOG"
            docker ps | tee -a "$LOG" || true
            N8N_NAME="$(docker ps --format '{{.Names}}' | awk '/(^|[_-])n8n([_-]|$)/{print $1; exit}')"
            [ -n "$N8N_NAME" ] && docker logs --tail 200 "$N8N_NAME" 2>&1 | tee -a "$LOG" || true
            docker logs --tail 200 caddy_reverse_proxy 2>&1 | tee -a "$LOG" || true
            exit 1
          fi

          echo "=== [deploy] done ===" | tee -a "$LOG"
          REMOTE
