name: CI/CD for N8N

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -Eeuo pipefail

            HOST_DOMAIN="https://n8n.portalgm.ru"
            REPO_DIR="/root/N8N"
            LOG="/var/log/n8n-deploy.log"
            touch "$LOG" && chmod 644 "$LOG" || true

            echo "=== [deploy] start ===" | tee -a "$LOG"

            # 1) Репозиторий
            if [ ! -d "$REPO_DIR/.git" ]; then
              echo "[deploy] cloning repo into $REPO_DIR" | tee -a "$LOG"
              git clone https://github.com/girudomed/N8N.git "$REPO_DIR"
            fi

            cd "$REPO_DIR"
            git fetch origin
            git reset --hard origin/main
            echo "[deploy] git reset -> origin/main" | tee -a "$LOG"

            # 2) Убедимся, что скрипт обновления на месте и исполняемый
            if [ ! -x "$REPO_DIR/nightly-update-n8n.sh" ]; then
              echo "[deploy] making nightly-update-n8n.sh executable" | tee -a "$LOG"
              chmod +x "$REPO_DIR/nightly-update-n8n.sh"
            fi

            # 3) Один источник правды: запуск апдейтера
            #    Он сам сделает backup (+архив), build и up -d
            echo "[deploy] running nightly-update-n8n.sh --force" | tee -a "$LOG"
            "$REPO_DIR/nightly-update-n8n.sh" --force | tee -a "$LOG"

            # 4) Лёгкая ротация архивов, чтобы не копились
            ls -1t /root/n8n_backups/n8n_data_*.tar.gz 2>/dev/null | tail -n +3 | xargs -r rm -f || true
            ls -1t /root/n8n_backups/n8n_image_*.tar.gz 2>/dev/null | tail -n +2 | xargs -r rm -f || true

            # 5) HEALTHCHECK (фаза 1): проверяем, что Caddy и домен отвечают
            echo "[deploy] health phase1: Caddy /health" | tee -a "$LOG"
            for i in {1..20}; do
              if curl -fsSIL --max-time 5 "${HOST_DOMAIN}/health" >/dev/null; then
                echo "[deploy] /health -> 200 (Caddy OK)" | tee -a "$LOG"
                break
              fi
              echo "[deploy] /health not ready yet (try $i), waiting 5s..." | tee -a "$LOG"
              sleep 5
              if [ "$i" -eq 20 ]; then
                echo "[deploy] FAIL: /health never became ready" | tee -a "$LOG"
                exit 1
              fi
            done

            # 6) HEALTHCHECK (фаза 2): ждём, пока n8n поднимется за прокси
            # Успехом считаем 200/204 ИЛИ 401 (BASIC AUTH включён — значит сервис жив)
            echo "[deploy] health phase2: wait n8n behind proxy" | tee -a "$LOG"
            READY=0
            for i in {1..40}; do
              CODE="$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${HOST_DOMAIN}/")"
              if [ "$CODE" = "200" ] || [ "$CODE" = "204" ] || [ "$CODE" = "401" ]; then
                echo "[deploy] n8n ready (HTTP $CODE)" | tee -a "$LOG"
                READY=1
                break
              fi
              echo "[deploy] n8n not ready yet (HTTP $CODE), try $i/40, wait 5s..." | tee -a "$LOG"
              sleep 5
            done

            if [ "$READY" -ne 1 ]; then
              echo "[deploy] FAIL: n8n did not become ready in time. Dumping diagnostics..." | tee -a "$LOG"
              docker ps | tee -a "$LOG" || true
              # попытка угадать имя контейнера n8n
              N8N_NAME="$(docker ps --format '{{.Names}}' | awk '/(^|[_-])n8n([_-]|$)/{print $1; exit}')"
              [ -n "$N8N_NAME" ] && docker logs --tail 200 "$N8N_NAME" 2>&1 | tee -a "$LOG" || true
              docker logs --tail 200 caddy_reverse_proxy 2>&1 | tee -a "$LOG" || true
              exit 1
            fi

            echo "=== [deploy] done ===" | tee -a "$LOG"