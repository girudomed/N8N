name: CI/CD for N8N

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -Eeuo pipefail

            REPO_DIR=/root/N8N
            LOG=/var/log/n8n-deploy.log
            touch "$LOG" && chmod 644 "$LOG" || true

            echo "=== [deploy] start ===" | tee -a "$LOG"

            # 1) Репозиторий
            if [ ! -d "$REPO_DIR/.git" ]; then
              echo "[deploy] cloning repo into $REPO_DIR" | tee -a "$LOG"
              git clone https://github.com/girudomed/N8N.git "$REPO_DIR"
            fi

            cd "$REPO_DIR"
            git fetch origin
            git reset --hard origin/main
            echo "[deploy] git reset -> origin/main" | tee -a "$LOG"

            # 2) Убедимся, что скрипт обновления на месте и исполняемый
            if [ ! -x "$REPO_DIR/nightly-update-n8n.sh" ]; then
              echo "[deploy] making nightly-update-n8n.sh executable" | tee -a "$LOG"
              chmod +x "$REPO_DIR/nightly-update-n8n.sh"
            fi

            # 3) Один источник правды: запуск апдейтера
            #    Он сам сделает backup (+архив), build и up -d
            echo "[deploy] running nightly-update-n8n.sh --force" | tee -a "$LOG"
            "$REPO_DIR/nightly-update-n8n.sh" --force | tee -a "$LOG"

            # 4) (опционально) лёгкая ротация архивов, чтобы не копились
            #    — оставляем последние 2 data-архива и последний image-архив
            ls -1t /root/n8n_backups/n8n_data_*.tar.gz 2>/dev/null | tail -n +3 | xargs -r rm -f || true
            ls -1t /root/n8n_backups/n8n_image_*.tar.gz 2>/dev/null | tail -n +2 | xargs -r rm -f || true

            # 5) НИКАКОГО nginx: у нас Caddy. Если нужно будет перечитать конфиг:
            # docker exec caddy_reverse_proxy caddy validate --config /etc/caddy/Caddyfile
            # docker exec caddy_reverse_proxy caddy reload --config /etc/caddy/Caddyfile

            # 6) Проверка доступности фронта
            echo "[deploy] health check" | tee -a "$LOG"
            curl -fsSIL --max-time 15 https://n8n.portalgm.ru >/dev/null

            echo "=== [deploy] done ===" | tee -a "$LOG"